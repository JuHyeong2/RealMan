<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="/css/preferences/audio.css" />
	<title>ì˜¤ë””ì˜¤ ì„¤ì •</title>
</head>
<body>
<div class="main">
	<div th:insert="preferences/preferencesSidebar.html"></div>
	<div class="container">
		<h2 class="title">ìŒì„±</h2>
		<hr><br/>

		<!-- ğŸ”¹ ì¥ì¹˜ ì„¤ì • -->
		<div class="section">
			<h3 class="section-title">ì¥ì¹˜ ì„¤ì •</h3>
			<div class="device-row">
				<div style="width: 48%;">
					<div class="device-label">ë…¹ìŒ ì¥ì¹˜</div>
					<select id="micSelect"></select>
					<div class="slider-container">
						<input type="range" min="1" max="100" value="70" class="slider" id="inputVolume">
					</div>
				</div>

				<div style="width: 48%;">
					<div class="device-label">ì¶œë ¥ ì¥ì¹˜</div>
					<select id="speakerSelect"></select>
					<div class="slider-container">
						<input type="range" min="1" max="100" value="70" class="slider" id="outputVolume">
					</div>
				</div>
			</div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ -->
		<div class="section">
			<h3 class="section-title">ë§ˆì´í¬ í…ŒìŠ¤íŠ¸</h3>
			<div class="mic-text">ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ "í…ŒìŠ¤íŠ¸ ì‹œì‘"ì„ ëˆ„ë¥´ì„¸ìš”.</div>
			<button class="test-button">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
			<button class="stop-button">í…ŒìŠ¤íŠ¸ ì¤‘ì§€</button>
			<div class="waveform"></div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ì…ë ¥ ë°©ì‹ -->
		<div class="section">
			<h3 class="section-title">ì…ë ¥ ë°©ì‹</h3>
			<div class="radio-group">
				<label class="radio-option selected">
					<input type="radio" name="inputType" value="A" checked> ìŒì„± ê°ì§€
				</label>
				<label class="radio-option">
					<input type="radio" name="inputType" value="P"> ëˆŒëŸ¬ì„œ ë§í•˜ê¸°
				</label>
			</div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ê¶Œí•œ ìš”ì²­ ë²„íŠ¼ -->
		<button class="request-permission">ë§ˆì´í¬ & ìŠ¤í”¼ì»¤ ê¶Œí•œ ìš”ì²­</button>

<!--		<button class="testButton">ë³´ë‚¼ ë³€ìˆ˜ ê°’ ë¶ˆëŸ¬ì˜¤ëŠ”ì§€ í™•ì¸ìš© ë²„íŠ¼</button>-->
	</div>
	<img
			alt="Xcircle"
			src="/image/preferences/Xcircle.png"
			width="50px"
			height="50px"
			onclick="goBack()"
			style="margin-top: 17px; margin-left: 150px; cursor: pointer"
	/>
</div>

<script>
	// ì´ˆê¸° ì‹¤í–‰ ë° í•¨ìˆ˜ í˜¸ì¶œ
	requestAudioPermission();

	// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
	window.addEventListener("DOMContentLoaded", async function () {
		await getAudioDevices();  // ì¥ì¹˜ ëª©ë¡ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¨ í›„

		document.querySelectorAll('.slider').forEach(slider => {
			slider.addEventListener('input', function() { updateSliderStyle(this); });
			updateSliderStyle(slider);
		});

		testButton.addEventListener("click", startMicTest);
		stopButton.addEventListener("click", stopMicTest);
		requestPermissionButton.addEventListener("click", requestAudioPermission);
		window.addEventListener("beforeunload", sendAudioPreferences);
	});

	// ìš”ì†Œ ì„ íƒ
	const micSelect = document.getElementById("micSelect");
	const speakerSelect = document.getElementById("speakerSelect");
	const testButton = document.querySelector(".test-button");
	const stopButton = document.querySelector(".stop-button");
	const requestPermissionButton = document.querySelector(".request-permission");
	const inputVolumeSlider = document.getElementById("inputVolume");
	const outputVolumeSlider = document.getElementById("outputVolume");
	const waveform = document.querySelector(".waveform");

	let micStream = null;
	let audioContext = null;
	let analyser = null;
	let source = null;

	// ì˜¤ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
	async function getAudioDevices() {
		const devices = await navigator.mediaDevices.enumerateDevices();
		micSelect.innerHTML = "";
		speakerSelect.innerHTML = "";

		devices.forEach(device => {
			const option = document.createElement("option");
			option.value = device.deviceId;
			option.textContent = device.label || "ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì¹˜";

			if (device.kind === "audioinput") {
				micSelect.appendChild(option);
			} else if (device.kind === "audiooutput") {
				speakerSelect.appendChild(option);
			}
		});
		await loadAudioPreferences(); // ê·¸ í›„ì— DBì—ì„œ ì„¤ì • ê°’ì„ ì ìš©
	}

	// ì˜¤ë””ì˜¤ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
	async function loadAudioPreferences() {
		try {
			const response = await fetch("/prefs/audio/getPrefs");
			const data = await response.json();

			if (data) {
				micSelect.value = data.audioInput || "";
				speakerSelect.value = data.audioOutput || "";
				inputVolumeSlider.value = data.inputValue || 50;
				outputVolumeSlider.value = data.outputValue || 50;

				setTimeout(() => {
					updateSliderStyle(inputVolumeSlider);
					updateSliderStyle(outputVolumeSlider);
				}, 0);

				document.querySelectorAll('input[name="inputType"]').forEach(radio => {
					if (radio.value === data.inputType) {
						radio.checked = true;
						radio.closest('.radio-option').classList.add('selected');
					} else {
						radio.closest('.radio-option').classList.remove('selected');
					}
				});
			}
		} catch (error) {
			console.error("ì˜¤ë””ì˜¤ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:", error);
		}
	}



	// ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
	function updateSliderStyle(slider) {
		const value = slider.value;
		slider.style.background = `linear-gradient(to right, #bed3e2 0%, #bed3e2 ${value}%, #e9ecef ${value}%, #e9ecef 100%)`;
	}

	// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘
	async function startMicTest() {
		try {
			if (micStream) stopMicTest();
			micStream = await navigator.mediaDevices.getUserMedia({
				audio: { deviceId: micSelect.value ? { exact: micSelect.value } : undefined }
			});

			audioContext = new AudioContext();
			analyser = audioContext.createAnalyser();
			source = audioContext.createMediaStreamSource(micStream);
			source.connect(analyser);

			drawWaveform();
		} catch (error) {
			console.error("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:", error);
			alert("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		}
	}

	// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘ì§€
	function stopMicTest() {
		if (micStream) {
			micStream.getTracks().forEach(track => track.stop());
			micStream = null;
		}
	}

	// ë§ˆì´í¬ ì…ë ¥ ì‹œê°í™”
	function drawWaveform() {
		const canvas = document.createElement("canvas");
		canvas.width = 1024;
		canvas.height = 40;
		waveform.innerHTML = "";
		waveform.appendChild(canvas);
		const ctx = canvas.getContext("2d");

		function update() {
			requestAnimationFrame(update);
			let dataArray = new Uint8Array(analyser.frequencyBinCount);
			analyser.getByteFrequencyData(dataArray);
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.fillStyle = "#7c3aed";

			let total = dataArray.slice(5, 41).reduce((sum, val) => sum + val, 0);
			let average = total / 36;
			ctx.fillRect(0, 0, average * 4, 100);
		}
		update();
	}

	// ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œ ìš”ì²­
	async function requestAudioPermission() {
		try {
			const permissionStatus = await navigator.permissions.query({ name: "microphone" });
			if (permissionStatus.state !== "granted") {
				await navigator.mediaDevices.getUserMedia({ audio: true });
				alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
				location.reload();
			}
		} catch (error) {
			console.error("ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
			alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
		}
	}

	// í™˜ê²½ì„¤ì • ì €ì¥
	function sendAudioPreferences() {
		const requestData = {
			audioInput: micSelect.value,
			inputValue: inputVolumeSlider.value,
			audioOutput: speakerSelect.value,
			outputValue: outputVolumeSlider.value,
			inputType: document.querySelector('input[name="inputType"]:checked').value,
		};

		const blob = new Blob([JSON.stringify(requestData)], { type: "application/json" });
		navigator.sendBeacon("/prefs/audio", blob);
	}

	// ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ íš¨ê³¼
	function selectOption(element) {
		document.querySelectorAll('.radio-option').forEach(option => option.classList.remove('selected'));
		element.classList.add('selected');
		element.querySelector('input[type="radio"]').checked = true;
	}

	function goBack() {
		const prev = sessionStorage.getItem("prevPage");
		if (prev) {
			window.location.href = prev;
		} else {
			window.location.href = "/main"; // fallback
		}
	}




</script>

</body>
</html>
