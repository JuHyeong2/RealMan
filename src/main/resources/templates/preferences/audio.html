<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="/css/preferences/audio.css" />
	<title>ì˜¤ë””ì˜¤ ì„¤ì •</title>
</head>
<body>
<div class="main">
	<div th:insert="preferences/preferencesSidebar.html"></div>
	<div class="container">
		<h2 class="title">ìŒì„±</h2>
		<hr><br/>

		<!-- ğŸ”¹ ì¥ì¹˜ ì„¤ì • -->
		<div class="section">
			<h3 class="section-title">ì¥ì¹˜ ì„¤ì •</h3>
			<div class="device-row">
				<div style="width: 48%;">
					<div class="device-label">ë…¹ìŒ ì¥ì¹˜</div>
					<select id="micSelect"></select>
					<div class="slider-container">
						<input type="range" min="1" max="100" value="70" class="slider" id="inputVolume">
					</div>
				</div>

				<div style="width: 48%;">
					<div class="device-label">ì¶œë ¥ ì¥ì¹˜</div>
					<select id="speakerSelect"></select>
					<div class="slider-container">
						<input type="range" min="1" max="100" value="70" class="slider" id="outputVolume">
					</div>
				</div>
			</div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ -->
		<div class="section">
			<h3 class="section-title">ë§ˆì´í¬ í…ŒìŠ¤íŠ¸</h3>
			<div class="mic-text">ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ "í…ŒìŠ¤íŠ¸ ì‹œì‘"ì„ ëˆ„ë¥´ì„¸ìš”.</div>
			<button class="test-button">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
			<button class="stop-button">í…ŒìŠ¤íŠ¸ ì¤‘ì§€</button>
			<div class="waveform"></div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ì…ë ¥ ë°©ì‹ -->
		<div class="section">
			<h3 class="section-title">ì…ë ¥ ë°©ì‹</h3>
			<div class="radio-group">
				<label class="radio-option selected">
					<input type="radio" name="inputType" value="A" checked> ìŒì„± ê°ì§€
				</label>
				<label class="radio-option">
					<input type="radio" name="inputType" value="P"> ëˆŒëŸ¬ì„œ ë§í•˜ê¸°
				</label>
			</div>
		</div>
		<br/><br/>

		<!-- ğŸ”¹ ê¶Œí•œ ìš”ì²­ ë²„íŠ¼ -->
		<button class="request-permission">ë§ˆì´í¬ & ìŠ¤í”¼ì»¤ ê¶Œí•œ ìš”ì²­</button>

		<button class="testButton">ë³´ë‚¼ ë³€ìˆ˜ ê°’ ë¶ˆëŸ¬ì˜¤ëŠ”ì§€ í™•ì¸ìš© ë²„íŠ¼</button>
	</div>
</div>

<script>
	let fingerprint = null;
	document.addEventListener("DOMContentLoaded", function () {
		const micSelect = document.getElementById("micSelect");
		const speakerSelect = document.getElementById("speakerSelect");
		const testButton = document.querySelector(".test-button");
		const stopButton = document.querySelector(".stop-button");
		const requestPermissionButton = document.querySelector(".request-permission");
		const inputVolumeSlider = document.getElementById("inputVolume");
		const outputVolumeSlider = document.getElementById("outputVolume");

		const waveform = document.querySelector(".waveform");
		let micStream = null;
		let audioContext = null;
		let analyser = null;

		let source = null;
		// fingerprint : ë„¤íŠ¸ì›Œí¬ ê¸°ì¤€ì˜  ì ‘ì† ê¸°ê¸° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
		async function getClientFingerprint() {
			const connection = new RTCPeerConnection();
			connection.createDataChannel("");

			// ğŸŸ¢ Offer ìƒì„± (ë¹„ë™ê¸° ì²˜ë¦¬)
			const offer = await connection.createOffer();

			// ğŸŸ¢ ë°˜ë“œì‹œ `setLocalDescription()`ì„ í˜¸ì¶œí•˜ì—¬ `localDescription` ì„¤ì •
			await connection.setLocalDescription(offer);

			connection.close();

			// ğŸŸ¢ Fingerprint ìƒì„± (Base64 ì¸ì½”ë”©)
			return btoa(connection.localDescription.sdp);
		}

// Fingerprint ì „ì—­ ë³€ìˆ˜ ì €ì¥
		getClientFingerprint().then(fp => {
			fingerprint = fp;
			console.log("Fingerprint:", fingerprint);
		});



		// ì˜¤ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
		async function getAudioDevices() {
			const devices = await navigator.mediaDevices.enumerateDevices();
			micSelect.innerHTML = "";
			speakerSelect.innerHTML = "";

			// ì¥ì¹˜ ëª©ë¡ì—ì„œ ì…ë ¥ ì¥ì¹˜ì™€ ì¶œë ¥ ì¥ì¹˜ë¥¼ êµ¬ë¶„í•˜ì—¬ ì¶”ê°€
			devices.forEach(device => {
				const option = document.createElement("option");
				option.value = device.deviceId;
				option.textContent = device.label || "ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì¹˜";

				if (device.kind === "audioinput") {
					micSelect.appendChild(option);
				} else if (device.kind === "audiooutput") {
					speakerSelect.appendChild(option);
				}
			});
		}

		// ìŠ¬ë¼ì´ë”ì˜ ê°’ì´ ë³€ê²½ë  ë•Œ ìŠ¬ë¼ì´ë” ë°”ì˜ ë°°ê²½ ìƒ‰ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
		document.querySelectorAll('.slider').forEach(slider => {
			slider.addEventListener('input', function() {
				const value = this.value; // í˜„ì¬ ìŠ¬ë¼ì´ë” ê°’ ê°€ì ¸ì˜¤ê¸°

				// ìŠ¬ë¼ì´ë”ì˜ ì§„í–‰ëœ ë¶€ë¶„(#7c3aed: ë³´ë¼ìƒ‰)ê³¼ ë‚¨ì€ ë¶€ë¶„(#e9ecef: íšŒìƒ‰)ì˜ ìƒ‰ìƒì„ ë™ì ìœ¼ë¡œ ë³€ê²½
				this.style.background = `linear-gradient(to right, #bed3e2 0%, #bed3e2 ${value}%, #e9ecef ${value}%, #e9ecef 100%)`;
			});

			// í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì´ˆê¸° ìŠ¬ë¼ì´ë” ê°’ì— ë§ì¶° ë°°ê²½ ìƒ‰ì„ ì„¤ì •
			const value = slider.value;
			slider.style.background = `linear-gradient(to right, #bed3e2 0%, #bed3e2 ${value}%, #e9ecef ${value}%, #e9ecef 100%)`;
		});

		// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘ í•¨ìˆ˜
		testButton.addEventListener("click", async function () {
			try {
				// ê¸°ì¡´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì´ ìˆìœ¼ë©´ ì¤‘ì§€
				if (micStream) stopMicTest();

				// ì„ íƒí•œ ë§ˆì´í¬ ì¥ì¹˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
				micStream = await navigator.mediaDevices.getUserMedia({
					audio: { deviceId: micSelect.value ? { exact: micSelect.value } : undefined }
				});

				// ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ë° ë¶„ì„ê¸° ìƒì„±
				audioContext = new AudioContext();
				analyser = audioContext.createAnalyser();
				source = audioContext.createMediaStreamSource(micStream);
				source.connect(analyser);

				// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œê°í™” ì‹œì‘
				drawWaveform();
				console.log("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘!");
			} catch (error) {
				console.error("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:", error);
				alert("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			}
		});

		// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘ì§€ í•¨ìˆ˜
		stopButton.addEventListener("click", function () {
			stopMicTest();
		});

		// ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ì¤‘ì§€í•˜ëŠ” í•¨ìˆ˜
		function stopMicTest() {
			if (micStream) {
				micStream.getTracks().forEach(track => track.stop());
				micStream = null;
			}
			console.log("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘ì§€ë¨.");
		}

		// ë§ˆì´í¬ ì…ë ¥ì„ ì‹œê°í™”í•˜ëŠ” í•¨ìˆ˜
		function drawWaveform() {
			// ìº”ë²„ìŠ¤ ìš”ì†Œ ìƒì„± ë° ì„¤ì •
			const canvas = document.createElement("canvas");
			canvas.width = 1024;
			canvas.height = 40;
			waveform.innerHTML = "";
			waveform.appendChild(canvas);
			const ctx = canvas.getContext("2d");

			// ì‹¤ì‹œê°„ íŒŒí˜• ì—…ë°ì´íŠ¸ í•¨ìˆ˜
			function update() {
				requestAnimationFrame(update);
				let dataArray = new Uint8Array(analyser.frequencyBinCount); // ì…ë ¥ëœ ì†Œë¦¬ë¥¼ ì£¼íŒŒìˆ˜ë³„ë¡œ ë‚˜ëˆ  ë°°ì—´ë¡œ ì €ì¥
				analyser.getByteFrequencyData(dataArray);
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.fillStyle = "#7c3aed";

				// dataArray[i] ëŠ” 0(ì €ìŒ ì˜ì—­)ë¶€í„° ìŒì—­ëŒ€ë³„ ì£¼íŒŒìˆ˜ê°€ ë”°ë¡œ ì €ì¥ë˜ì–´ìˆê¸° ë•Œë¬¸ì—
				// totalì— ì‚¬ëŒ ìŒì„±ì„ ì¡ê¸° ì í•©í•œ(5~40 = 300Hz ~ 3kHz ) ì£¼íŒŒìˆ˜ê°’ì„ í•©ì³ í‰ê· ê°’ ìƒì„±
				let volumeMin = 5; // ì €ìŒ ì£¼íŒŒìˆ˜ ì˜ì—­
				let volumeMax = 40 // ê³ ìŒ ì˜ì—­
				let total = 0;
				for (let i = volumeMin; i <= volumeMax; i++) {
					total += dataArray[i];
				}
				let average = total / (volumeMax - volumeMin + 1);
				ctx.fillRect(0, 0, average*4, 100);
			}
			update();
		}
		// ë¸Œë¼ìš°ì €ì—ì„œ ê¶Œí•œ ìš”ì²­
		async function requestAudioPermission() {
			try {
				// ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ í™•ì¸
				const permissionStatus = await navigator.permissions.query({ name: "microphone" }); // ê¶Œí•œ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
				if (permissionStatus.state === "granted") { //  "granted"(í—ˆìš©ë¨), "denied"(ê±°ë¶€ë¨), "prompt"(ìš”ì²­ ê°€ëŠ¥)
					return;
				}
				// ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì€ ê²½ìš° ê¶Œí•œ ìš”ì²­
				await navigator.mediaDevices.getUserMedia({ audio: true });
				alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
				location.reload(); // ê¶Œí•œì„ ìƒˆë¡œ í—ˆìš©í•œ ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
			} catch (error) {
				console.error("ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
				alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
			}
		}

		// ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œ ìˆ˜ë™ ìš”ì²­ ë²„íŠ¼ ê¸°ëŠ¥
		requestPermissionButton.addEventListener("click", async function () {
			try {
				// ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ í™•ì¸
				const permissionStatus = await navigator.permissions.query({ name: "microphone" }); // ê¶Œí•œ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
				if (permissionStatus.state === "granted") { //  "granted"(í—ˆìš©ë¨), "denied"(ê±°ë¶€ë¨), "prompt"(ìš”ì²­ ê°€ëŠ¥)
					// ì´ë¯¸ ê¶Œí•œì´ í—ˆìš©ëœ ê²½ìš° ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ
					alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
					return;
				}
				// ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì€ ê²½ìš° ê¶Œí•œ ìš”ì²­
				await navigator.mediaDevices.getUserMedia({ audio: true });
				alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
				location.reload(); // ê¶Œí•œì„ ìƒˆë¡œ í—ˆìš©í•œ ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
			} catch (error) {
				console.error("ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:", error);
				alert("ë§ˆì´í¬ ë° ìŠ¤í”¼ì»¤ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
			}
		});

		// 'ì…ë ¥ ë°©ì‹'ì˜ ë¼ë””ì˜¤ ë²„íŠ¼ div íš¨ê³¼
		function selectOption(element) {
			// ëª¨ë“  ì˜µì…˜ì—ì„œ 'selected' í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ì—¬ ì„ íƒ íš¨ê³¼ ì´ˆê¸°í™”
			document.querySelectorAll('.radio-option').forEach(option => {
				option.classList.remove('selected');
			});

			// í´ë¦­í•œ ì˜µì…˜ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€ (ì„ íƒëœ ìƒíƒœë¡œ í‘œì‹œ)
			element.classList.add('selected');

			// í´ë¦­í•œ ì˜µì…˜ì˜ ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì²´í¬ ìƒíƒœë¡œ ë³€ê²½
			element.querySelector('input[type="radio"]').checked = true;
		}

		// í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°; ì˜¤ë””ì˜¤ì¥ì¹˜ ê¶Œí•œ ìš”ì²­;
		requestAudioPermission();
		getAudioDevices();
	});

	// í™˜ê²½ì„¤ì • ê°’ì„ ë°±ì—”ë“œë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
	async function sendAudioPreferences() {
		// fingerprint ê°’ì€ ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ í˜¸ì¶œ ì œê±°)
		if (!fingerprint) {
			console.error("Fingerprint ê°’ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
			return;
		}

		// HTML ìš”ì†Œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
		const micSelect = document.getElementById("micSelect").value;
		const inputVolume = document.getElementById("inputVolume").value;
		const speakerSelect = document.getElementById("speakerSelect").value;
		const outputVolume = document.getElementById("outputVolume").value;
		const inputType = document.querySelector('input[name="inputType"]:checked').value;

		// ì „ì†¡í•  ë°ì´í„° ê°ì²´ ìƒì„±
		const requestData = {
			audioInput: micSelect,
			inputValue: inputVolume,
			audioOutput: speakerSelect,
			outputValue: outputVolume,
			inputType: inputType,
			deviceId: fingerprint // ì´ë¯¸ ì €ì¥ëœ fingerprint ê°’ ì‚¬ìš©
		};

		console.log("ë³´ë‚¼ ë°ì´í„°:", requestData); // ë””ë²„ê¹…ìš© ë¡œê·¸

		// ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
		try {
			const response = await fetch("/prefs/audio", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(requestData)
			});

			if (response.ok) {
				console.log("í™˜ê²½ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
			} else {
				console.error("í™˜ê²½ì„¤ì • ì €ì¥ ì‹¤íŒ¨:", response.status);
			}
		} catch (error) {
			console.error("ì„œë²„ ìš”ì²­ ì˜¤ë¥˜:", error);
		}
	}

	// í˜ì´ì§€ë¥¼ ë²—ì–´ë‚  ë•Œ ì„¤ì • ê°’ ì €ì¥ (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€)
	window.addEventListener("beforeunload", sendAudioPreferences);


	// ê°’ë¶ˆëŸ¬ì˜¤ëŠ” í…ŒìŠ¤íŠ¸ìš© ë²„íŠ¼
	document.addEventListener("DOMContentLoaded", function () {
		// "testButton" í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
		const testButton = document.querySelector(".testButton");

		// ë²„íŠ¼ í´ë¦­ ì‹œ í™˜ê²½ì„¤ì • ê°’ í™•ì¸
		testButton.addEventListener("click", ()=>{
			const micSelect = document.getElementById("micSelect").value;
			const inputVolume = document.getElementById("inputVolume").value;
			const speakerSelect = document.getElementById("speakerSelect").value;
			const outputVolume = document.getElementById("outputVolume").value;
			const inputType = document.querySelector('input[name="inputType"]:checked').value;

			alert('ë§ˆì´í¬ : ' + micSelect
					+ '/ ë§ˆì´í¬ë³¼ë¥¨ : ' + inputVolume
					+ '/ ìŠ¤í”¼ì»¤ : ' + speakerSelect
					+ '/ ìŠ¤í”¼ì»¤ë³¼ë¥¨ : ' + outputVolume
					+ '/ ì…ë ¥ë°©ì‹ : ' + inputType);
		});
	});


</script>

</body>
</html>
