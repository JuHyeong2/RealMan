<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>chatting</title>
    <link rel="stylesheet" href="/css/chat/chatting.css" />
    <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdn.tiny.cloud/1/dmox8bb1ulyjmgc2jhvx42updw5ctl45g0dr1fbgc3ne7hwf/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>

	<style>
		body, html {
			height: 100%;
		}
		.top-bar {
			height: 40px;
			background-color: #E4EDF3;
		}
		.sidebar {
			height: calc(100vh - 40px);
			background-color: #E4EDF3;
		}
		.chat-area {
			flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
			width: 1120px;
		}
		.user-list {
			width: 360px;
		}
		@media (max-width: 768px) {
			.top-bar {
				display: none !important;
			}
			.sidebar {
				height: 100vh;
			}
			.chat-area, .user-list {
				display: none;
			}
		}
	</style>
    
</head>
<body>

	<!-- íƒ‘ë°” -->
	<div th:replace="~{/common/top :: html}"></div>
	<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ-->
	<div class="main-container d-flex">
		<!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
		<div class="sidebar d-flex">
			<!-- ì„œë²„ ëª©ë¡ (ì¡°ê° ì½”ë“œ í¬í•¨) -->
			<div th:replace="~{/common/sidebar :: body}"></div>
			<!-- ì±„íŒ… ì±„ë„ ëª©ë¡ (ì¡°ê° ì½”ë“œ í¬í•¨) -->
			<div th:replace="~{chattingSidebar :: html}"></div>
		</div>
	
		<!-- ì±„íŒ… ê³µê°„ -->
		<div class="chat-area d-flex flex-column">
			<div class="flex-grow-1 overflow-auto p-3">
				<input type="hidden" th:value="${no}">
				<div class="chatContent">
					<div class='textArea' th:each="c, cStat:${chatList}">
						<b> [[${c.sender}]] : [[${c.message}]]</b><p>&nbsp</p>
					</div>
				</div>
			</div>
			<div class="p-3 d-flex">
				<textarea class="flex-grow-1" id="mytextarea"></textarea>
			    <button id="button-send">ì…ë ¥</button>
			</div>
		</div>
	
		<!-- ìœ ì € ëª©ë¡ -->
		<div class="user-list bg-light p-3 overflow-auto">
			<div th:each="i : ${#numbers.sequence(1, 20)}">
				ìœ ì € #[[${i}]]
			</div>
		</div>
	</div>


	<script th:inline="javascript">
		onload=()=>{
			/*<![CDATA[*/
			const username = /*[[${member.memberNickname}]]*/null;
			const serverNo = /*[[${serverNo}]]*/0;
			const channelNo = /*[[${channelNo}]]*/0;
			/*]]*/
			

			// console.log("serverNo : " + serverNo);
			// console.log("channelNo : " + channelNo);
			// console.log("username : " + username);
			
			// WebSocket ì—°ê²°
			const socket = new SockJS("https://192.168.40.4:9090/stomp/chat");
			const stompClient = Stomp.over(socket);
			
			stompClient.connect({}, ()=>{
				console.log("WebSocket ì—°ê²° ì„±ê³µ!");
				
				// íŠ¹ì • ì±„íŒ…ë°©(roomId) êµ¬ë…
				stompClient.subscribe('/sub/chatroom/' + channelNo, (message)=>{
					const chatMessage =JSON.parse(message.body);
					console.log("ìƒˆ ë©”ì‹œì§€:" + chatMessage.sender + ": " + chatMessage.message);
					let today = new Date();
		            
	 	            let hour = String(today.getHours());
	 	            let minute = String(today.getMinutes());
	 	            let second = String(today.getSeconds());
		            
	 	            if(hour.length == 1){
	 	            	hour = '0' + hour;
	 	            }
		            
	 	            if(minute.length == 1){
	 	            	minute = '0' + minute;
	 	            }
		            
	 	            if(second.length == 1){
	 	            	second = '0' + second;
	 	            }
		            
		            
	 	            let HMS = hour + ':' + minute + ':' + second;
					let str = `<div class='textArea'>
								  <b>${chatMessage.sender} :</b> ${chatMessage.message}
								  <p>${HMS}</p>
           						</div>`;
	 	            document.querySelector('.chatContent').insertAdjacentHTML("afterbegin", str);

	 	            // ìŠ¤í¬ë¡¤ ì´ë™
	 	          	document.querySelector('.chatContent').scrollTop = document.querySelector('.chatContent').scrollHeight;
				});

				// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
				const sendMessage=(sender, message, roomId)=>{
					stompClient.send('/pub/chat/' + channelNo + '/' + 'C', {}, JSON.stringify({ roomId, sender, message }));
				}

				
				document.querySelector('#button-send').addEventListener('click', ()=>{
					let msg = document.querySelector('textarea');
					sendMessage(username, msg.value, channelNo);
					msg.value = '';
				});
			})
			


			// TinyMCE ì´ˆê¸°í™”
			tinymce.init({
				selector: '#mytextarea',
				plugins: 'image paste',
				menubar: false,
				toolbar: ' image | bullist numlist | undo redo',
				height: 120,
				width: '100%',
				images_upload_handler: function (blobInfo, success, failure) {
					let reader = new FileReader();
					reader.onload = function () {
						let base64URL = reader.result;
						success(base64URL); // Base64 URLì„ ì—ë””í„°ì— ì‚½ì…
						// console.log("Base64 Image URL:", base64URL);
					};
					reader.readAsDataURL(blobInfo.blob());
				},
				images_upload_url: '/upload-image',
				automatic_uploads: true,
				paste_data_images: true
			});


			document.querySelector('#button-send').addEventListener('click', ()=>{


				let msg = tinymce.get('mytextarea').getContent({ format: 'html' }); // HTML ê°€ì ¸ì˜¤ê¸°
				let imgTagMatch = msg.match(/<img[^>]+src="([^">]+)"/); // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë§Œ ì¶”ì¶œ


				if (imgTagMatch) {
					let imgSrc = imgTagMatch[1]; // Base64 ì´ë¯¸ì§€ URL
					let imgTag = `<img src="${imgSrc}" style="width: 300px; height: 200px;">`; // í¬ê¸° ì§€ì •

					// ê¸°ì¡´ ë©”ì‹œì§€ + ìˆ˜ì •ëœ ì´ë¯¸ì§€ íƒœê·¸
					let newContent = msg.replace(/<img[^>]+>/, imgTag);

					sendMessage(username, newContent, serverNo); // ìˆ˜ì •ëœ ë©”ì‹œì§€ ì „ì†¡
				} else {
					sendMessage(username, msg, serverNo); // ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° ê¸°ì¡´ ë©”ì‹œì§€ ì „ì†¡
				}

				tinymce.get('mytextarea').setContent('');


			});



			//@ì–¸ê¸‰ê¸°ëŠ¥



				let searchBox = null;
				let autoCompleteBox = null;
				let inputField = null;
				let mentionStartIndex = -1;
				let nowIndex = -1; // í˜„ì¬ ì„ íƒëœ ìë™ì™„ì„± í•­ëª©

				const chatInput = document.querySelector("textarea"); // âœ… ì…ë ¥ì°½ ì°¾ê¸°
				if (!chatInput) {
					return;
				}


				// @ ì…ë ¥ ê°ì§€
				chatInput.addEventListener("keydown", function (event) {
					if (event.key === "@") {
						mentionStartIndex = chatInput.selectionStart;
						event.preventDefault(); // âœ… ê¸°ë³¸ ë™ì‘ ë°©ì§€
						createSearchBox(chatInput);
					}

					if (searchBox) {
						if (event.key === "ArrowDown") {
							event.preventDefault();
							moveSelection(1);
						} else if (event.key === "ArrowUp") {
							event.preventDefault();
							moveSelection(-1);
						} else if (event.key === "Enter" && nowIndex > -1) {
							event.preventDefault();
							selectItem();
						} else if (event.key === "Escape") {
							removeSearchBox();
						}
					}
				});

				// ì…ë ¥ ì´ë²¤íŠ¸ (ìë™ì™„ì„± ì—…ë°ì´íŠ¸)
				chatInput.addEventListener("input", function () {
					if (searchBox) {
						updateAutoComplete();
					}
				});

				function createSearchBox(inputElement) {
					console.log("searchBox ìƒì„±ë¨");

					if (searchBox) return;
					console.log("searchBox ìƒì„±ë¨");

					searchBox = document.createElement("div");
					searchBox.style.position = "absolute";
					searchBox.style.zIndex = "1000";
					searchBox.style.background = "white";
					searchBox.style.border = "1px solid #ccc";
					searchBox.style.padding = "5px";
					searchBox.style.borderRadius = "5px";
					searchBox.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
					searchBox.style.width = "200px";

					autoCompleteBox = document.createElement("div");
					autoCompleteBox.classList.add("autocomplete");
					searchBox.appendChild(autoCompleteBox);

					document.body.appendChild(searchBox);
					positionSearchBox(inputElement);

					inputField = inputElement;
				}

				function positionSearchBox(inputElement) {
					const rect = inputElement.getBoundingClientRect();
					searchBox.style.top = `${rect.bottom + window.scrollY}px`;
					searchBox.style.left = `${rect.left + window.scrollX}px`;
				}

				function updateAutoComplete() {
					const text = inputField.value;
					const cursorPosition = inputField.selectionStart;

					const atIndex = text.lastIndexOf("@", cursorPosition);
					if (atIndex === -1) {
						removeSearchBox();
						return;
					}

					const value = text.substring(atIndex + 1, cursorPosition).toLowerCase();
					autoCompleteBox.innerHTML = "";
					nowIndex = -1; // ì´ˆê¸°í™”

					if (value.trim() !== "") {
						const filteredMembers = memberList.filter(member =>
								member.memberNickName.toLowerCase().includes(value)
						);

						console.log("ğŸ”¹ í•„í„°ë§ëœ ë‹‰ë„¤ì„:", filteredMembers.map(m => m.memberNickName));

						filteredMembers.forEach((member, index) => {
							const item = document.createElement("div");
							item.innerHTML = highlightText(member.memberNickName, value);
							item.classList.add("autocomplete-item");
							item.dataset.index = index;

							item.addEventListener("click", function () {
								insertMention(member.memberNickName, atIndex);
							});

							autoCompleteBox.appendChild(item);
						});
					}
				}

				function moveSelection(direction) {
					const items = autoCompleteBox.querySelectorAll(".autocomplete-item");
					if (items.length === 0) return;

					nowIndex += direction;
					if (nowIndex < 0) nowIndex = items.length - 1;
					if (nowIndex >= items.length) nowIndex = 0;

					items.forEach((item, index) => {
						item.classList.toggle("active", index === nowIndex);
					});
				}

				function selectItem() {
					const items = autoCompleteBox.querySelectorAll(".autocomplete-item");
					if (nowIndex > -1 && nowIndex < items.length) {
						insertMention(items[nowIndex].textContent, mentionStartIndex);
					}
				}

				function insertMention(name, atIndex) {
					const beforeText = inputField.value.substring(0, atIndex + 1);
					const afterText = inputField.value.substring(inputField.selectionStart);
					inputField.value = beforeText + name + " " + afterText;
					removeSearchBox();
				}

				function highlightText(text, query) {
					const regex = new RegExp(`(${query})`, "gi");
					return text.replace(regex, "<mark>$1</mark>");
				}

				function removeSearchBox() {
					if (searchBox) {
						searchBox.remove();
						searchBox = null;
						nowIndex = -1;
					}
				}

				/*<![CDATA*/
				const memberList = /*[[${ServerMember}]]*/ null /*]]>*/

				// âœ… ì—”í„° í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
				chatInput.addEventListener("keydown", (e) => {
					if (e.keyCode === 13) {
						e.preventDefault();
						document.querySelector("#button-send").click();
					}
				});

				console.log(memberList);





		}
	</script>
	
</body>
</html>