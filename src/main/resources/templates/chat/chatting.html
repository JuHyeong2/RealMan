<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>chatting</title>
    <link rel="stylesheet" href="/css/chat/chatting.css" />
    <link rel="stylesheet" href="/css/chat/memberList.css" />
    <!--    <link href="/css/common/sidebar.css" rel="stylesheet" type="text/css" />-->
    <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script
      src="https://cdn.tiny.cloud/1/dmox8bb1ulyjmgc2jhvx42updw5ctl45g0dr1fbgc3ne7hwf/tinymce/5/tinymce.min.js"
      referrerpolicy="origin"
    ></script>

    <style>
      body,
      html {
        height: 100%;
      }
      .top-bar {
        height: 40px;
        background-color: #e4edf3;
      }
      .sidebar {
        height: calc(100vh - 40px);
        background-color: #e4edf3;
      }
      .chat-area {
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        width: 1120px;
      }
      .user-list {
        width: 360px;
      }
      @media (max-width: 768px) {
        .top-bar {
          display: none !important;
        }
        .sidebar {
          height: 100vh;
        }
        .chat-area,
        .user-list {
          display: none;
        }
      }

      .addServer{
        width: 60px;
        height: 60px;
        background-color: #BDD3E2;
        cursor: pointer;
        border-radius: 100px;
        align-content: center;
        text-align: center;
        font-size: 20px;
      }

      /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
      .add-modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.4);
        z-index: 9998;
        display: none;
      }

      /* ëª¨ë‹¬ ë³¸ì²´ */
      .add-modal {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        width: 400px;
        height: 400px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        border-radius: 10px;
        z-index: 9999;
        display: none;
      }

      .add-modal .close {
        float: right;
        font-size: 20px;
        cursor: pointer;
      }
      .add-modalbtn{
        background: #699fff;
      }
      .add-modalbtn:hover{
        background: #2c58a2;
      }

    </style>
  </head>
  <body>
    <!-- íƒ‘ë°” -->
    <div th:replace="~{/common/top :: body}"></div>
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ-->
    <div class="main-container d-flex">
      <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
      <div class="sidebar d-flex">
        <!-- ì„œë²„ ëª©ë¡ (ì¡°ê° ì½”ë“œ í¬í•¨) -->
        <div th:replace="~{/common/sidebar :: body}"></div>
        <!-- ì±„íŒ… ì±„ë„ ëª©ë¡ (ì¡°ê° ì½”ë“œ í¬í•¨) -->
        <div th:replace="~{chattingSidebar :: html}"></div>
      </div>

      <!-- ì±„íŒ… ê³µê°„ -->
      <div class="chat-area d-flex flex-column">
        <div class="flex-grow-1 overflow-auto p-3">
          <input type="hidden" th:value="${no}" />
          <div class="chatContent">
            <div class="textArea" th:each="c, cStat:${chatList}">
              <div
                th:if="${(cStat.index > 0 and cStat.index + 1 < chatList.size() and
                #strings.substring(chatList[cStat.index + 1].createDate,0,10) != #strings.substring(c.createDate,0,10))
              or (cStat.index + 1 == chatList.size())}"
                class="date-separator"
              >
                <span th:text="${#strings.substring(c.createDate,0,10)}"></span>
              </div>

              <div class="chatContent-1">
                <img
                  th:src="${c.profileUrl != null ? c.profileUrl : '/image/member/no-profile.svg'}"
                  width="40px"
                  height="40px"
                />
                <div class="chatContent-2">
                  <b th:utext="${c.sender}"></b>&nbsp;<span
                    th:utext="${c.createDate}"
                    style="font-size: 14px"
                  ></span>
                  <p th:utext="${c.message}" style="margin: 0"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-3 d-flex">
          <textarea class="flex-grow-1" id="mytextarea"></textarea>
          <!--           <button id="button-send">ì…ë ¥</button> -->
        </div>
      </div>
      <input type="hidden" id="serverNo" th:value="${serverNo}" />

      <!-- ìœ ì € ëª©ë¡ -->
      <div
        th:replace="~{memberList :: div}"
        class="user-list bg-light p-3 overflow-auto"
      ></div>
    </div>

    <script src="/js/chat/memberList.js"></script>
    <script src="/js/common/sideBar.js"></script>
    <script th:inline="javascript">
      onload = () => {
        // let mytext = document.getElementById('mytextarea');
        /*<![CDATA[*/
        const memberList = /*[[${memberList}]]*/ null;
        const username = /*[[${member.memberNickname}]]*/ null;
        const userProfileImage = /*[[${member.imageUrl}]]*/ null;
        const serverNo = /*[[${serverNo}]]*/ 0;
        const channelNo = /*[[${channelNo}]]*/ 0;
        /*]]>*/
        console.log("memberList:" + memberList[0]);

        let enterText;

        // WebSocket ì—°ê²°
        // const socket = new SockJS("https://192.168.40.6:9090/stomp/chat");
        //const socket = new SockJS("https://192.168.140.22:9090/stomp/chat");
        const socket = new SockJS("https://localhost:8080/stomp/chat");
//         const socket = new SockJS("https://192.168.40.6:9090/stomp/chat");
//         const socket = new SockJS("https://192.168.140.4:8080/stomp/chat");
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
          console.log("WebSocket ì—°ê²° ì„±ê³µ!");

          // íŠ¹ì • ì±„íŒ…ë°©(roomId) êµ¬ë…
          stompClient.subscribe("/sub/chatroom/" + channelNo, (message) => {
            // chatMessageëŠ” JSONìœ¼ë¡œ parseí•´ì„œ ê°€ì ¸ì˜´
            const chatMessage = JSON.parse(message.body);

            // í˜„ì¬ ì‹œê°„ ë°›ì•„ì˜¤ê¸°
            let today = new Date();

            let hour = String(today.getHours());
            let minute = String(today.getMinutes());
            let second = String(today.getSeconds());

            if (hour.length == 1) {
              hour = "0" + hour;
            }

            if (minute.length == 1) {
              minute = "0" + minute;
            }

            if (second.length == 1) {
              second = "0" + second;
            }

            let HMS = hour + ":" + minute + ":" + second;
            // 					<div style='margin:0;  padding: 0; flex-grow: 1;'>${chatMessage.message}</div>
            // ë°›ì•„ì˜¨ ë©”ì‹œì§€ ì±„íŒ…ë°©ì— ì¶œë ¥í•˜ê¸°
            let str = `<div class='chatContent-1'>
            						  <img src=${
                            chatMessage.profileUrl != null
                              ? chatMessage.profileUrl
                              : "/image/member/no-profile.svg"
                          } width="40px" height="40px">
            						  <div class='chatContent-2'>
	      								  <b>${chatMessage.sender}</b>
	      								  <div style='display:flex; justify-content:space-between; align-items:flex-end;'>
	      								  	${chatMessage.message}
	      								  	<p>${HMS}</p>
	      								  </div>
      								  </div>
                 		</div>`;
            document
              .querySelector(".chatContent")
              .insertAdjacentHTML("afterbegin", str);

            // ìŠ¤í¬ë¡¤ ì´ë™
            document.querySelector(".chatContent").scrollTop =
              document.querySelector(".chatContent").scrollHeight;
          });

          // ë©”ì‹œì§€ ì „ì†¡í•˜ëŠ” ë©”ì„œë“œ
          const sendMessage = (sender, message, roomId) => {
            if (!message || message.trim() === "" || message === "<p></p>") {
              alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
              return;
            }

            // ê°ì²´í™”
            const sendData = { roomId, sender, message };

            console.log(`âœ… ì „ì†¡ ë°ì´í„°:`, sendData);

            stompClient.send(
              `/pub/chat/${roomId}/C`,
              {},
              JSON.stringify(sendData)
            );
          };

          enterText = () => {
            let msg = tinymce
              .get("mytextarea")
              .getContent({ format: "html" })
              .trim(); // HTML ê°€ì ¸ì˜¤ê¸°

            let imgTagMatch = msg.match(/<img[^>]+src="([^">]+)"/);
            if (imgTagMatch) {
              let imgSrc = imgTagMatch[1];
              let imgTag = `<img src="${imgSrc}" style="width: 300px; height: 200px;">`;
              let newContent = msg.replace(/<img[^>]+>/, imgTag);
              sendMessage(username, newContent, channelNo);
            } else {
              sendMessage(username, msg, channelNo);
            }

            tinymce.get("mytextarea").setContent("");
          };

          //           document.querySelector("#button-send").addEventListener("click", () => {
          //               let msg = tinymce.get("mytextarea").getContent({ format: "html" }).trim(); // HTML ê°€ì ¸ì˜¤ê¸°

          //               let imgTagMatch = msg.match(/<img[^>]+src="([^">]+)"/);
          //               if (imgTagMatch) {
          //                 let imgSrc = imgTagMatch[1];
          //                 let imgTag = `<img src="${imgSrc}" style="width: 300px; height: 200px;">`;
          //                 let newContent = msg.replace(/<img[^>]+>/, imgTag);
          //                 sendMessage(username, newContent, channelNo);
          //               } else {
          //                 sendMessage(username, msg, channelNo);
          //               }

          //               tinymce.get("mytextarea").setContent("");
          //             });
        });

        // TinyMCE ì´ˆê¸°í™”
        tinymce.init({
          selector: "#mytextarea",
          plugins: "image paste",
          menubar: false,
          toolbar: false,
          statusbar: false,
          height: "70px",
          width: "100%",
          resize: false,
          content_style: "body{border-radius: 50px;}",
          content_css: "/css/common/tinymce.css",
          images_upload_handler: function (blobInfo, success, failure) {
            let reader = new FileReader();
            reader.onload = function () {
              let base64URL = reader.result;

              // âœ… ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ íƒœê·¸ ì¶”ê°€
              let imgTag = `<img src="${base64URL}" style="width: 150px; height: 150px;">`;

              console.log("ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€:", imgTag);
              success(base64URL);
            };
            reader.readAsDataURL(blobInfo.blob());
          },
          images_upload_url: "/upload-image",
          automatic_uploads: true,
          paste_data_images: true,
          setup: function (editor) {
            let mentionBox = null;
            let mentionText = "";
            // const memberList = /*[[${ServerMember}]]*/ [];  // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë©¤ë²„ ëª©ë¡

            editor.on("keydown", function (event) {
              if (event.key === "@") {
                mentionText = ""; // @ ì…ë ¥ ì‹œ ì´ˆê¸°í™”
                setTimeout(() => showMentionBox(editor), 10);
              } else if (mentionBox) {
                if (event.key === "ArrowDown" || event.key === "ArrowUp") {
                  event.preventDefault();
                  moveSelection(event.key === "ArrowDown" ? 1 : -1);
                } else if (event.key === "Enter" && mentionText) {
                  event.preventDefault();
                  selectItem();
                } else if (event.key === "Escape") {
                  removeMentionBox();
                }
              } else {
                if (event.key == "Enter" && !event.shiftKey) {
                  event.preventDefault();
                  // 						        document.querySelector('#button-send').click();
                  enterText();
                }
              }
            });

            //  `input` ì´ë²¤íŠ¸ì—ì„œ mentionText ì—…ë°ì´íŠ¸
            editor.on("input", function () {
              let content = editor.getContent({ format: "text" }); // í˜„ì¬ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
              let words = content.split(/\s+/); // ê³µë°± ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
              let lastWord = words[words.length - 1]; // ë§ˆì§€ë§‰ ë‹¨ì–´ ê°€ì ¸ì˜¤ê¸°

              if (lastWord.startsWith("@")) {
                mentionText = lastWord.slice(1); // @ ì œì™¸í•œ í…ìŠ¤íŠ¸ ì €ì¥
                console.log("í˜„ì¬ ì…ë ¥í•œ mentionText:", mentionText);
                updateMentionList();
              } else {
                mentionText = ""; // @ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ì´ˆê¸°í™”
                removeMentionBox();
              }
            });

            document.addEventListener("click", function (event) {
              if (mentionBox && !mentionBox.contains(event.target)) {
                removeMentionBox();
              }
            });

            function showMentionBox(editor) {
              if (mentionBox) mentionBox.remove();

              mentionBox = document.createElement("div");
              mentionBox.classList.add("mention-box");
              Object.assign(mentionBox.style, {
                position: "absolute",
                zIndex: "1000",
                background: "white",
                border: "1px solid #ccc",
                padding: "5px",
                borderRadius: "5px",
                boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)",
                width: "200px",
                display: "block",
              });

              document.body.appendChild(mentionBox);
              positionMentionBox(editor);
              updateMentionList();
            }

            function positionMentionBox(editor) {
              const node = editor.selection.getNode();
              const rect = node.getBoundingClientRect();
              mentionBox.style.top = `${rect.bottom + window.scrollY + 5}px`;
              mentionBox.style.left = `${rect.right + window.scrollX + 10}px`;
            }

            function updateMentionList() {
              mentionBox.innerHTML = "";

              if (!mentionText) {
                mentionBox.innerHTML = "<div>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>";
                return;
              }

              let filteredMembers = memberList.filter((member) =>
                member.memberNickname
                  .toLowerCase()
                  .includes(mentionText.toLowerCase())
              );

              if (filteredMembers.length === 0) {
                mentionBox.innerHTML = "<div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                return;
              }

              filteredMembers.forEach((member) => {
                let item = document.createElement("div");
                item.classList.add("mention-item");
                item.dataset.nickname = member.memberNickname;
                item.innerHTML = member.memberNickname.replace(
                  new RegExp(mentionText, "gi"),
                  (match) =>
                    `<span style="color: blue; font-weight: bold;">${match}</span>`
                );
                item.style.padding = "5px";
                item.style.cursor = "pointer";

                item.addEventListener("click", function () {
                  insertMention(editor, member.memberNickname);
                });
                mentionBox.appendChild(item);
              });
            }

            let selectedIndex = 0; // ì„ íƒëœ ì•„ì´í…œì˜ ì¸ë±ìŠ¤ ì €ì¥

            function moveSelection(direction) {
              const items = mentionBox.querySelectorAll(".mention-item");
              if (items.length === 0) return;

              selectedIndex += direction;
              if (selectedIndex < 0) selectedIndex = items.length - 1;
              if (selectedIndex >= items.length) selectedIndex = 0;

              items.forEach((item, index) => {
                item.style.backgroundColor =
                  index === selectedIndex ? "#ddd" : "white";
              });
            }

            function selectItem() {
              const items = mentionBox.querySelectorAll(".mention-item");
              if (items.length > 0) {
                insertMention(editor, items[selectedIndex].dataset.nickname);
              }
            }

            function insertMention(editor, name) {
              const range = editor.selection.getRng();
              const startNode = range.startContainer;
              const startOffset = range.startOffset;

              // ê¸°ì¡´ '@ + ì…ë ¥í•œ í…ìŠ¤íŠ¸' ì‚­ì œ
              const textContent = startNode.textContent;
              const atIndex = textContent.lastIndexOf("@"); // ë§ˆì§€ë§‰ '@' ìœ„ì¹˜ ì°¾ê¸°
              if (atIndex !== -1) {
                startNode.deleteData(atIndex, mentionText.length + 1); // @ + ì…ë ¥í•œ í…ìŠ¤íŠ¸ ê¸¸ì´ë§Œí¼ ì‚­ì œ
              }

              // ìƒˆë¡œìš´ ë©˜ì…˜ ì‚½ì…
              const newText = `@${name} `;
              startNode.insertData(atIndex, newText);

              // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì • (ë©˜ì…˜ ì‚½ì… í›„ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™)
              editor.selection.setCursorLocation(
                startNode,
                atIndex + newText.length
              );

              removeMentionBox();
            }

            function removeMentionBox() {
              if (mentionBox) {
                mentionBox.remove();
                mentionBox = null;
                mentionText = "";
              }
            }
          },
        });
      };
    </script>
  </body>
</html>
