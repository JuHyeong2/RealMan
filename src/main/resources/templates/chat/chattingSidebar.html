<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>chattingSidebar</title>
    <link rel="stylesheet" href="/css/chat/chattingSidebar.css"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
</head>
<body>

	<div class="channel-list bg-light d-flex flex-column" style="width: 320px;">
	    <nav>
	    	<h4 class="channel"><img src="/image/Dropdown.png">&nbspìŒì„± ì±„ë„</h4>
	    	<div class="voiceChat" th:each="c : ${channel}" th:if='${c.channelSeparator eq "V"}'>
	    		<ul>
		    		<li>
		    			<a href="#"><img src="/image/Voice.png">&nbsp[[${c.channelName}]]</a>
		    			<ul></ul>
		    		</li>
	    		</ul>
	    	</div>
	
	    	<h4 class="channel"><img src="/image/Dropdown.png">&nbspì±„íŒ… ì±„ë„</h4>
		    <div class="textChat">
				<li th:each="c : ${channel}" th:if="${c.channelSeparator == 'T'}" onclick="goToChat(event);"><a th:href="@{'/chat/main/'+${serverNo}+'/'+${c.channelNo}}"><img src="/image/chat.png">&nbsp[[${c.channelName}]]</a></li>
			</div>
		    <ul>
		    <li></li>
		    </ul>

    	</nav>

    	
    	<div class="profile">
    		<img src="/image/profile.png" width="50px" onclick="ProfileModal()">
    		<b th:text="${member.memberNickname}" onclick="goToMyAccount()"></b>
    		<img id="micImg" src="/image/preferences/mic.png" width="30px">
    		<img src="/image/preferences/Headphones.png" width="30px">
    		<img src="/image/preferences/Preferences.png" width="30px" onclick="goToMyAccount()">
    	</div>


	</div>




	<!-- í”„ë¡œí•„ ëª¨ë‹¬ -->
	<div id="profileModal" class="modal">
	    <div class="modal-content">
	        <span class="close" onclick="closeProfileModal()">&times;</span>
	
	        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
	        <div class="profile-modal-header">
	            <img src="/image/no-profile.svg" width="80px">
	        </div>
	
	        <h2>í”„ë¡œí•„ ì„¤ì •</h2>
	
	        <label for="statusSelect">ìƒíƒœ ë³€ê²½</label>
	        <select id="statusSelect">
	            <option value="online">ğŸŸ¢ ì˜¨ë¼ì¸</option>
	            <option value="away">ğŸŸ¡ ìë¦¬ë¹„ì›€</option>
	            <option value="offline">âš« ì˜¤í”„ë¼ì¸</option>
	        </select>
	
	        <button onclick="goToMyAccount()">ë‚´ ì •ë³´ ìˆ˜ì •</button>
	    </div>
	</div>
		
	
	<script>
		// ìŒì„± ì±„íŒ…ë°© ë“œë¡­ë‹¤ìš´
		document.querySelectorAll('.channel')[0].addEventListener('click', ()=>{

			const myNickname = document.querySelectorAll('.profile')[0].querySelector('b').innerText;
			const voiceChannels = document.querySelectorAll('.voiceChat');
			for(const voiceChannel of voiceChannels){
// 				console.log(voiceChannel);
				const chatRoom = voiceChannel.querySelector('li');
// 				console.log(chatRoom);
				if(chatRoom.style.display == '' || chatRoom.style.display == 'none'){
					chatRoom.style.display = 'block';
// 					people.style.display = 'block';	
				}else{
					chatRoom.style.display = 'none';
// 					people.style.display = 'none';
				}	
				
				
				
				voiceChannel.addEventListener('click', ()=>{
					
					
// 					$.ajax({
// 						url: '/chat/updateChannelUser',
// 						success: data=>{
// 							const lis = voiceChannel.querySelectorAll('ul>li>ul li');
// 							console.log(lis);
// 							if(lis.length == 0){
// 								voiceChannel.querySelector('ul>li>ul').innerHTML += '<li><img src="/image/profile.png">&nbsp' + myNickname + '</li>';
// 							}
// 							for(const li of lis){
// // 								console.log(li);
// 								if(li == null){
// 									voiceChannel.querySelector('ul>li>ul').innerHTML += '<li><img src="/image/profile.png">&nbsp' + myNickname + '</li>';
// 								}else{
// 									if(li.innerText.trim() == myNickname){
// 										console.log(voiceChannel.querySelector('ul>li>ul>li').innerText);
// 									}else{
// // 										console.log(li.innerText.trim());
// // 										console.log(myNickname);
// 										voiceChannel.querySelector('ul>li>ul').innerHTML += '<li><img src="/image/profile.png">&nbsp' + myNickname + '</li>';
// 									}
// 								}
// 							}
									
// 						}
// 					})
				})

			}
		})
		
		/*<![CDATA[*/
			const channels = /*[[${channel}]]*/null;
		/*]]*/
		
// 		for(const channel of channels){
// 			if(channel.channelSeparator == 'V'){
				
// 			}
// 		}
		
		const channelSocket = new SockJS("https://192.168.40.6:9090/stomp/channel");
		const channelStompClient = Stomp.over(socket);
		
		channelStompClient.connect({}, ()=>{
			console.log('channelSocket ì—°ê²° ì„±ê³µ');
			
			// ë³´ì´ìŠ¤ ì±„ë„ ì‚¬ìš©ì ëª©ë¡ êµ¬ë…
			channelStompClient.subscribe("/topic/voice", (message)=>{
				updateUserList(JSON.pase(message.body));
			});
		});
		
		// ë³´ì´ìŠ¤ ì±„ë„ ì…ì¥ í•¨ìˆ˜
		const joinVoiceChannel=(username)=>{
		    stompClient.send("/chat/joinVoice", {}, username);
		}

		// ë³´ì´ìŠ¤ ì±„ë„ í‡´ì¥ í•¨ìˆ˜
		const leaveVoiceChannel=(username)=>{
		    stompClient.send("/chat/leaveVoice", {}, username);
		}

		// ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
		const updateUserList=(users)=> {
		    const userList = document.getElementById("voice-users");
		    userList.innerHTML = "";
		    users.forEach(user => {
		        let li = document.createElement("li");
		        li.textContent = user;
		        userList.appendChild(li);
		    });
		}
		
		// ì±„íŒ… ì±„íŒ…ë°© ë“œë¡­ë‹¤ìš´
		document.querySelectorAll('.channel')[1].addEventListener('click', ()=>{

			const chatRooms = document.querySelectorAll('.textChat')[0].querySelectorAll('li');
			const people = document.querySelector('nav > ul:nth-of-type(2) ul li');
			
			for(const chatRoom of chatRooms){
				if(chatRoom.style.display == '' || chatRoom.style.display == 'none'){
					chatRoom.style.display = 'block';
					people.style.display = 'block';	
				}else{
					chatRoom.style.display = 'none';
					people.style.display = 'none';
				}

			}
			
			
		})
		
		// í•´ë‹¹ ì±„íŒ… ì±„ë„ í´ë¦­ì‹œ í•´ë‹¹ ì±„ë„ë¡œ ì´ë™
		const goToChat=(e)=>{
			
		}
		
		// í”„ë¡œí•„ ì‚¬ì§„, ë‹‰ë„¤ì„, í†±ë‹ˆë°”í€´ í´ë¦­ì‹œ ë‚´ê³„ì • í˜ì´ì§€ë¡œ ì´ë™
// 		const goToMyAccount=()=>{
// 			location.href = '/prefs/myProfile';
// 		}
	</script>
	
	 <script>
        // í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°
        function ProfileModal() {
            document.getElementById("profileModal").style.display = "block";
        }

        // í”„ë¡œí•„ ëª¨ë‹¬ ë‹«ê¸°
        function closeProfileModal() {
            document.getElementById("profileModal").style.display = "none";
        }

        // ë‚´ ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™
        function goToMyAccount() {
            location.href = '/prefs/myProfile';
        }

    </script>

</body>
</html>